<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduQuest | Game Edition</title>
    <style>
        :root { --primary: #4a90e2; --secondary: #2ecc71; --dark: #2c3e50; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding-top: 80px; text-align: center; }
        
        /* NAVBAR */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-logo { font-weight: bold; font-size: 1.5em; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .settings-gear { font-size: 24px; cursor: pointer; transition: transform 0.8s ease; display: inline-block; }
        .settings-gear:hover { transform: rotate(180deg); }

        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        
        /* CARDS */
        .grade-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-top: 20px; }
        .grade-card { background: #fff; border: 2px solid #eee; padding: 20px; border-radius: 15px; cursor: pointer; transition: 0.3s; }
        .grade-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        
        input { width: 80%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        canvas { border-radius: 15px; background: #2c3e50; cursor: crosshair; touch-action: none; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-logo">ğŸš€ EduQuest</div>
        <div class="nav-right">
            <button onclick="location.href='leaderboard.html'" style="background:none; color:var(--primary); padding:5px;">ğŸ† Leaderboard</button>
            <span class="settings-gear" onclick="location.href='settings.html'">âš™ï¸</span>
        </div>
    </div>

    <div class="container">
        <div id="auth-section">
            <h2>Student Login</h2>
            <input type="email" id="auth-email" placeholder="Gmail Address">
            <input type="password" id="auth-password" placeholder="Password">
            <div>
                <button onclick="handleAuth('login')">Login</button>
                <button onclick="handleAuth('signup')" style="background: var(--secondary);">Sign Up</button>
            </div>
        </div>

        <div id="game-section" class="hidden">
            <h3>Choose Your Grade</h3>
            <div class="grade-grid" id="grade-grid"></div>

            <div id="quiz-area" class="hidden">
                <div class="grade-card" style="width: 100%; cursor: default;">
                    <h2 id="grade-title"></h2>
                    <p style="color: var(--primary); font-weight: bold;">Question <span id="q-count">1</span> / 10</p>
                    <p id="q-text" style="font-size: 1.6em; margin: 20px 0; font-weight: bold;"></p>
                    <input type="text" id="q-input" placeholder="Your answer...">
                    <br>
                    <button onclick="nextQuestion()">Submit Answer</button>
                </div>
            </div>

            <div id="mini-game-container" class="hidden">
                <h3>ğŸ® Bonus Level: Catch the Stars!</h3>
                <p>Catch 10 stars to unlock your code!</p>
                <canvas id="gameCanvas" width="500" height="300"></canvas>
                <h2 id="game-score">Stars: 0</h2>
            </div>

            <div id="grade-complete" class="hidden" style="background: #d4edda; padding: 30px; border-radius: 15px;">
                <h2 style="color: #155724;">ğŸ‰ Level Mastered!</h2>
                <p>Here is your reward code:</p>
                <h1 id="final-code" style="letter-spacing: 5px; color: var(--primary);"></h1>
                <button onclick="location.reload()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPk1zIZRAtOmHcyAIEZErl9JNSkXQPBv8",
            authDomain: "backend-2870f.firebaseapp.com",
            projectId: "backend-2870f",
            storageBucket: "backend-2870f.firebasestorage.app",
            messagingSenderId: "103357825196",
            appId: "1:103357825196:web:1645af7ca7f95339835f09"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 1. NON-SIMILAR QUESTION GENERATOR
        function generateRandomQuestion(grade) {
            const ops = ['+', '-', '*'];
            const op = grade < 4 ? ops[Math.floor(Math.random() * 2)] : ops[Math.floor(Math.random() * 3)];
            let n1 = Math.floor(Math.random() * (grade * 5)) + 5;
            let n2 = Math.floor(Math.random() * (grade * 2)) + 2;

            if (grade >= 9) { // High School Algebra
                let x = Math.floor(Math.random() * 12) + 1;
                let multiplier = Math.floor(Math.random() * 5) + 2;
                return { q: `Solve for x: ${multiplier}x = ${multiplier * x}`, a: x.toString() };
            }
            
            let questionText, answer;
            if (op === '+') { questionText = `${n1} + ${n2}`; answer = n1 + n2; }
            else if (op === '-') { questionText = `${n1 + n2} - ${n1}`; answer = n2; }
            else { questionText = `${n1} Ã— ${n2}`; answer = n1 * n2; }

            return { q: `What is ${questionText}?`, a: answer.toString() };
        }

        // 2. AUTH & STATE
        async function handleAuth(type) {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            try {
                if(type === 'signup') {
                    const res = await auth.createUserWithEmailAndPassword(e, p);
                    await res.user.sendEmailVerification();
                    window.location.href = "verify.html";
                } else {
                    const res = await auth.signInWithEmailAndPassword(e, p);
                    if(!res.user.emailVerified) { alert("Verify your Gmail!"); auth.signOut(); }
                }
            } catch (err) { alert(err.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user && user.emailVerified) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('game-section').classList.remove('hidden');
                setupGrid();
            }
        });

        // 3. GAMEPLAY LOGIC
        let curG, solved = 0, currentQ = {};
        function setupGrid() {
            const grid = document.getElementById('grade-grid');
            grid.innerHTML = "";
            const icons = ["ğŸŒ±","ğŸ€","ğŸŒ»","ğŸ","ğŸ“š","ğŸ§¬","ğŸ§ª","ğŸŒ","âš–ï¸","ğŸ›ï¸","ğŸŒŒ","ğŸ“"];
            for(let i=1; i<=12; i++) {
                grid.innerHTML += `<div class="grade-card" onclick="startQuiz(${i})"><i>${icons[i-1]}</i><br>Grade ${i}</div>`;
            }
        }

        function startQuiz(g) {
            curG = g; solved = 0;
            document.getElementById('grade-grid').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('grade-title').innerText = `Grade ${g} Challenge`;
            newQuestion();
        }

        function newQuestion() {
            currentQ = generateRandomQuestion(curG);
            document.getElementById('q-text').innerText = currentQ.q;
            document.getElementById('q-count').innerText = solved + 1;
            document.getElementById('q-input').value = "";
            document.getElementById('q-input').focus();
        }

        function nextQuestion() {
            if(document.getElementById('q-input').value.trim() === currentQ.a) {
                solved++;
                if(solved < 10) newQuestion();
                else startMiniGame();
            } else { alert("Incorrect! Try again."); }
        }

        // 4. MINI GAME (STAR CATCHER)
        function startMiniGame() {
            document.getElementById('quiz-area').classList.add('hidden');
            document.getElementById('mini-game-container').classList.remove('hidden');
            
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            let starsCaught = 0;
            let basketX = 225;
            let star = { x: Math.random() * 450, y: 0 };

            canvas.onmousemove = (e) => { basketX = e.offsetX - 35; };
            // Touch support for mobile
            canvas.ontouchmove = (e) => { basketX = e.touches[0].clientX - canvas.offsetLeft - 35; e.preventDefault(); };

            function draw() {
                ctx.clearRect(0,0,500,300);
                // Star
                ctx.font = "30px Arial";
                ctx.fillText("â­", star.x, star.y);
                star.y += 4;
                // Basket
                ctx.fillStyle = "#4a90e2";
                ctx.fillRect(basketX, 270, 70, 15);

                if(star.y > 270 && star.x > basketX && star.x < basketX + 70) {
                    starsCaught++;
                    document.getElementById('game-score').innerText = "Stars: " + starsCaught;
                    star = { x: Math.random() * 450, y: 0 };
                }
                if(star.y > 300) star = { x: Math.random() * 450, y: 0 };

                if(starsCaught < 10) requestAnimationFrame(draw);
                else {
                    document.getElementById('mini-game-container').classList.add('hidden');
                    document.getElementById('grade-complete').classList.remove('hidden');
                    document.getElementById('final-code').innerText = "QUEST-" + curG + "-WIN";
                    saveToFirestore("QUEST-" + curG + "-WIN");
                }
            }
            draw();
        }

        async function saveToFirestore(code) {
            const user = auth.currentUser;
            await db.collection("users").doc(user.uid).update({
                unlockedCodes: firebase.firestore.FieldValue.arrayUnion(code)
            });
        }
    </script>
</body>
</html>