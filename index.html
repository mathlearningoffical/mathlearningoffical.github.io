<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Learning</title>
    <style>
        :root { --primary: #4a90e2; --secondary: #2ecc71; --dark: #2c3e50; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        
        /* Profile Section */
        .profile-header { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 15px; border-radius: 15px; border: 1px solid #ddd; margin-bottom: 20px; }
        .avatar { width: 60px; height: 60px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid var(--primary); }

        /* Grade Grid */
        .grade-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0; }
        .grade-card { background: white; border: 2px solid #eee; padding: 20px; border-radius: 15px; cursor: pointer; transition: 0.3s; }
        .grade-card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .grade-card i { font-size: 40px; display: block; margin-bottom: 10px; }

        input { width: 80%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .reward-box { background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸš€ EduQuest</h1>
        
        <div id="auth-section">
            <h3>Login or Create Account</h3>
            <input type="email" id="auth-email" placeholder="Gmail Address">
            <input type="password" id="auth-password" placeholder="Password">
            <div>
                <button onclick="handleAuth('login')">Login</button>
                <button onclick="handleAuth('signup')" style="background: var(--secondary);">Create Account</button>
            </div>
            <p id="auth-msg" style="color: red;"></p>
        </div>

        <div id="game-section" class="hidden">
            <div class="profile-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="avatar" id="user-avatar">ğŸ‘¤</div>
                    <div style="text-align: left;">
                        <strong id="user-tag"></strong><br>
                        <small>Verified Student âœ…</small>
                    </div>
                </div>
                <button onclick="logout()" style="background:#e74c3c; font-size: 12px;">Logout</button>
            </div>

            <h3>Choose Your Grade Level</h3>
            <div class="grade-grid" id="grade-grid">
                </div>

            <div id="quiz-area" class="hidden">
                <div class="grade-card" style="width: 100%; cursor: default;">
                    <h2 id="current-grade-title">Grade X</h2>
                    <p id="q-text" style="font-size: 1.5em;"></p>
                    <input type="text" id="q-input" placeholder="Type answer...">
                    <br>
                    <button onclick="nextQuestion()">Submit Answer</button>
                </div>
            </div>

            <div id="grade-complete" class="reward-box hidden">
                <h3>ğŸ‰ Grade Mastered!</h3>
                <p>Secret Code: <strong id="final-code"></strong></p>
                <button onclick="redeemAuto()">Add to My Vault</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // PASTE YOUR REAL KEYS HERE
        const firebaseConfig = {
            apiKey: "AIzaSyDPk1zIZRAtOmHcyAIEZErl9JNSkXQPBv8",
            authDomain: "backend-2870f.firebaseapp.com",
            projectId: "backend-2870f",
            storageBucket: "backend-2870f.firebasestorage.app",
            messagingSenderId: "103357825196",
            appId: "1:103357825196:web:1645af7ca7f95339835f09"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Grade Icons (Profile Pictures for Grades)
        const gradeIcons = ["ğŸŒ±", "ğŸ€", "ğŸŒ»", "ğŸ", "ğŸ“š", "ğŸ§¬", "ğŸ§ª", "ğŸŒ", "âš–ï¸", "ğŸ›ï¸", "ğŸŒŒ", "ğŸ“"];

        // 1. GENERATE GRADE CARDS
        const grid = document.getElementById('grade-grid');
        for(let i=1; i<=12; i++) {
            grid.innerHTML += `
                <div class="grade-card" onclick="startQuiz(${i})">
                    <i>${gradeIcons[i-1]}</i>
                    <strong>Grade ${i}</strong>
                </div>
            `;
        }

        // 2. AUTHENTICATION WITH EMAIL VERIFICATION
        async function handleAuth(type) {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const msg = document.getElementById('auth-msg');

            try {
                if(type === 'signup') {
                    const res = await auth.createUserWithEmailAndPassword(email, password);
                    await res.user.sendEmailVerification();
                    await db.collection("users").doc(res.user.uid).set({ unlockedCodes: [], avatar: "ğŸ‘¤" });
                    alert("Verification email sent! Check your inbox.");
                    auth.signOut();
                } else {
                    const res = await auth.signInWithEmailAndPassword(email, password);
                    if(!res.user.emailVerified) {
                        alert("Please verify your email first!");
                        auth.signOut();
                    }
                }
            } catch (e) { msg.innerText = e.message; }
        }

        auth.onAuthStateChanged(user => {
            if(user && user.emailVerified) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('game-section').classList.remove('hidden');
                document.getElementById('user-tag').innerText = user.email;
            }
        });

        function logout() { auth.signOut().then(() => location.reload()); }

        // 3. QUIZ LOGIC
        let curG, curQ = 0;
        function startQuiz(g) {
            curG = g; curQ = 0;
            document.getElementById('grade-grid').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('current-grade-title').innerText = `Grade ${g} Challenge`;
            showQ();
        }

        function showQ() {
            document.getElementById('q-text').innerText = `What is ${curG} + ${curQ + 1}?`;
            document.getElementById('q-input').value = "";
        }

        function nextQuestion() {
            if(document.getElementById('q-input').value == (curG + curQ + 1)) {
                curQ++;
                if(curQ < 3) { // Shortened to 3 questions for testing
                    showQ();
                } else {
                    document.getElementById('quiz-area').classList.add('hidden');
                    document.getElementById('grade-complete').classList.remove('hidden');
                    document.getElementById('final-code').innerText = `MASTER-G${curG}`;
                }
            } else { alert("Try again!"); }
        }

        async function redeemAuto() {
            const code = document.getElementById('final-code').innerText;
            const user = auth.currentUser;
            await db.collection("users").doc(user.uid).update({
                unlockedCodes: firebase.firestore.FieldValue.arrayUnion(code)
            });
            alert("Code saved to your vault!");
            location.reload();
        }
    </script>
</body>
</html>